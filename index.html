<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendy Production - Pro v7.5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --bg: #050a18;
            --blue: #00d2ff;
            --purple: #9d50bb;
            --glass: rgba(255, 255, 255, 0.08);
            --gold: #ffd700;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            background: var(--bg);
            color: white;
            direction: rtl;
            overflow-x: hidden;
        }

        /* Sidebar System */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 260px;
            height: 100%;
            background: #0a0f1e;
            border-right: 1px solid var(--blue);
            transition: 0.3s ease-in-out;
            z-index: 9999;
            padding: 20px;
        }

        .sidebar.active { left: 0; }

        .sidebar-item {
            padding: 15px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
            background: rgba(255,255,255,0.02);
        }

        .sidebar-item:hover {
            background: var(--glass);
            color: var(--blue);
            transform: scale(1.02);
        }

        .menu-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            font-size: 26px;
            cursor: pointer;
            z-index: 10000;
            color: var(--blue);
            background: #0a0f1e;
            padding: 5px 12px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Home User Header */
        .home-user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--glass);
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            border: 1px solid rgba(0, 210, 255, 0.3);
            width: fit-content;
            margin: 0 0 30px auto;
            transition: 0.3s;
        }

        .home-user-card:hover {
            background: rgba(0, 210, 255, 0.1);
            border-color: var(--blue);
        }

        .home-user-card img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--blue);
        }

        /* Content Layout */
        .content-section {
            display: none;
            padding: 80px 20px;
            max-width: 1100px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            width: 280px;
            text-align: center;
            position: relative;
            transition: 0.3s;
        }

        .card:hover { transform: translateY(-5px); border-color: var(--blue); }

        .promo { border: 2px solid #ff4757; }
        .promo::after {
            content: "Ø¹Ø±Ø¶ Ø®Ø§Øµ";
            position: absolute;
            top: -10px;
            right: 10px;
            background: #ff4757;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 11px;
        }

        .btn-pay {
            background: linear-gradient(45deg, var(--blue), var(--purple));
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .btn-delete-admin {
            background: #ff4757;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            margin-top: 8px;
            font-size: 12px;
        }

        /* Forum Styling */
        .status-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-right: 4px solid var(--blue);
            position: relative;
        }

        .admin-post {
            border: 2px solid var(--gold) !important;
            background: rgba(255, 215, 0, 0.05) !important;
        }

        .pinned-post {
            border-right: 6px solid var(--gold) !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
        }

        .pin-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--gold);
            font-size: 18px;
        }

        .reply-box {
            margin-right: 40px;
            border-right: 2px solid var(--blue);
            padding: 10px 15px;
            font-size: 13px;
            background: rgba(255,255,255,0.03);
            margin-top: 8px;
            border-radius: 8px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1a1f3c;
            border: 1px solid #333;
            color: white;
            border-radius: 10px;
            box-sizing: border-box;
        }

        footer {
            background: #000;
            padding: 40px 20px;
            text-align: center;
            border-top: 1px solid #222;
            margin-top: 50px;
        }

        .wa-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #25d366;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            margin: 5px;
            font-weight: bold;
        }

        .admin-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            margin: 4px;
            font-weight: bold;
        }

        /* New Admin Styles */
        .admin-user-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--blue);
            object-fit: cover;
        }

        #search-user-input {
            border: 1px solid var(--blue);
            margin-bottom: 20px;
            background: rgba(0, 210, 255, 0.05);
        }
    </style>
</head>
<body>

    <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>

    <nav class="sidebar" id="sidebar">
        <h2 style="color: var(--blue); text-align: center; margin-bottom: 30px;">Trendy Prod.</h2>
        <div class="sidebar-item" onclick="openPage('home')"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="sidebar-item" onclick="openPage('profile')"><i class="fas fa-user-edit"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
        <div class="sidebar-item" onclick="openPage('cart')"><i class="fas fa-shopping-basket"></i> Ø§Ù„Ø³Ù„Ø©</div>
        <div class="sidebar-item" onclick="openPage('wait')"><i class="fas fa-spinner"></i> Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
        <div class="sidebar-item" onclick="openPage('history')"><i class="fas fa-file-invoice-dollar"></i> ÙÙˆØ§ØªÙŠØ± Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="sidebar-item" onclick="openPage('forum')"><i class="fas fa-comments"></i> Ø§Ù„Ù…Ù†ØªØ¯Ù‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</div>
        <div class="sidebar-item" onclick="openPage('about')"><i class="fas fa-info-circle"></i> Ø¹Ù† Trendy</div>

        <div id="admin-zone" style="display:none; border-top: 1px solid var(--gold); margin-top: 20px; padding-top: 15px;">
            <p style="color:var(--gold); font-size:12px; margin-bottom:10px; letter-spacing: 1px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            <div class="sidebar-item" onclick="openPage('adm-add')"><i class="fas fa-plus-square"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</div>
            <div class="sidebar-item" onclick="openPage('adm-users')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        </div>

        <button onclick="logout()" style="width:100%; margin-top:30px; padding:12px; background:#ff4757; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div id="login-box" style="text-align:center; padding-top:25vh;">
        <h1 style="font-size: 3.5rem; letter-spacing: 5px; color: var(--blue); margin-bottom: 0;">TRENDY</h1>
        <p style="margin-bottom: 35px; color: #888; font-weight: 300; letter-spacing: 2px;">PRODUCTION SERVICES</p>
        <button onclick="login()" style="padding:16px 50px; border-radius:50px; cursor:pointer; font-weight:bold; background:#fff; border:none; box-shadow: 0 10px 30px rgba(0,0,0,0.4); transition: 0.3s; font-size: 16px;">
            <i class="fab fa-google" style="margin-left: 10px; color: #db4437;"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google
        </button>
    </div>

    <div id="main-app" style="display:none;">

        <section id="home" class="content-section" style="display:block;">
            <div class="home-user-card" onclick="openPage('profile')">
                <img id="head-user-pic" src="https://via.placeholder.com/45">
                <div>
                    <div id="head-user-name" style="font-weight: bold; font-size: 14px;">ØªØ­Ù…ÙŠÙ„...</div>
                    <small style="color: var(--blue); font-size: 10px;">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</small>
                </div>
            </div>

            <h2 style="text-align:center; font-size: 2.2rem; margin-bottom: 40px; text-shadow: 0 0 10px var(--blue);">Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ ğŸ›’</h2>
            <div id="products-grid" style="display:flex; flex-wrap:wrap; gap:25px; justify-content:center;"></div>
        </section>

        <section id="profile" class="content-section" style="text-align:center;">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
            <div style="position: relative; width: 140px; margin: 0 auto;">
                <img id="my-pic" style="width:140px; height:140px; border-radius:50%; border:3px solid var(--blue); object-fit:cover; background: #222;">
                <button onclick="document.getElementById('pic-input').click()" style="position: absolute; bottom: 5px; right: 5px; background: var(--blue); border: none; width: 40px; height: 40px; border-radius: 50%; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);"><i class="fas fa-camera"></i></button>
            </div>
            <input type="file" id="pic-input" hidden onchange="uploadProfilePic()">

            <div style="max-width: 400px; margin: 40px auto;">
                <label style="display: block; text-align: right; margin-bottom: 8px; color: var(--blue);">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                <input type="text" id="my-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§">
                <button onclick="saveProfileName()" class="btn-pay">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </section>

        <section id="cart" class="content-section">
            <h2 style="text-align: center;">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h2>
            <div id="cart-content" style="max-width: 600px; margin: 0 auto;"></div>
        </section>

        <section id="wait" class="content-section">
            <h2 style="text-align: center;">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â³</h2>
            <div id="wait-list" style="max-width: 600px; margin: 0 auto;"></div>
        </section>

        <section id="history" class="content-section">
            <h2 style="text-align: center;">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªÙŠ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ âœ…</h2>
            <div id="history-list" style="max-width: 600px; margin: 0 auto;"></div>
        </section>

        <section id="forum" class="content-section">
            <h2 style="text-align: center;">Ø§Ù„Ù…Ù†ØªØ¯Ù‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ğŸ’¬</h2>
            <div style="background: var(--glass); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                <textarea id="forum-msg" rows="4" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ø±Ø£ÙŠÙƒØŒ Ø§Ù‚ØªØ±Ø§Ø­ÙƒØŒ Ø£Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ..."></textarea>
                <div style="display:flex; gap:12px; align-items: center; margin-top: 10px;">
                    <label for="forum-img" style="cursor: pointer; background: #1a1f3c; padding: 12px 20px; border-radius: 10px; border: 1px solid #333;"><i class="fas fa-image" style="color: var(--blue);"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©</label>
                    <input type="file" id="forum-img" accept="image/*" hidden>
                    <button onclick="postToForum()" class="btn-pay" style="width:180px; margin-top:0; height: 46px;">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
                </div>
            </div>
            <div id="forum-list" style="margin-top:40px;"></div>
        </section>

        <section id="about" class="content-section">
            <div style="background:var(--glass); padding:40px; border-radius:25px; border:1px solid var(--blue); line-height:1.9; text-align:center;">
                <h2 style="color:var(--blue); font-size: 2.2rem; margin-bottom: 25px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒÙ… ÙÙŠ Trendy Production ğŸš€</h2>
                <p style="font-size: 17px;">Ø§Ø­Ù†Ø§ Ø´Ø±ÙƒØ© Ù…ØµØ±ÙŠØ© Ø¨Ø¯Ø£Øª Ø¨Ø£Ø´Ø®Ø§Øµ Ù‡Ø¯ÙÙ‡Ù… Ø¥Ù†Ù‡Ù… ÙŠÙˆÙØ±ÙˆØ§ Ù„Ùƒ Ø£ÙØ¶Ù„ "Services" ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… ÙˆØ¨Ø£Ø±Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŒ ÙˆØ¹Ø´Ø§Ù† Ø¥Ø­Ù†Ø§ Ø¹Ø§Ø±ÙÙŠÙ† Ø¥Ù† Ø®Ø¯Ù…Ø§Øª ÙƒØªÙŠØ± Ø¨Ù‚Ù‰ Ø£Ø³Ø¹Ø§Ø±Ù‡Ø§ ØºØ§Ù„ÙŠØ© Ø£Ùˆ Ù…Ø´ Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ù…ØµØ±ØŒ Ù‚Ø±Ø±Ù†Ø§ Ù†ÙˆÙØ±Ù‡Ø§ Ù„ÙƒÙ… Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ¨Ø¶Ù…Ø§Ù† ÙƒØ§Ù…Ù„.</p>
                <p style="font-size: 17px;">Ø¹Ø§Ø±ÙÙŠÙ† Ø¥Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø±Ù‡ Ø¨Ù‚Øª ØµØ¹Ø¨Ø© ÙˆØ¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Ù‚Ø±Ø±Ù†Ø§ Ù†ÙˆÙØ± Ù„Ùƒ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø£ØµÙ„ÙŠØ© Ø¨Ø£Ø³Ø¹Ø§Ø± Ø®ÙŠØ§Ù„ÙŠØ©ØŒ ÙˆØ¨Ø£Ù…Ø§Ù† ØªØ§Ù… Ù„Ø­Ø³Ø§Ø¨ÙƒØŒ ÙˆØ¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡ Ø­Ù„Ù…Ù†Ø§ Ù‡ÙŠÙƒØ¨Ø± Ø¨ÙŠÙƒÙ… ÙˆØ¨Ø«Ù‚ØªÙƒÙ… ÙÙŠÙ†Ø§.</p>
                <div style="margin-top: 35px; font-weight: bold; color: var(--gold); font-size: 18px; border-top: 1px solid rgba(255,215,0,0.2); padding-top: 20px;">Trendy Production - Ø¨Ù†ÙƒØ¨Ø± Ø¨ÙŠÙƒÙ…!</div>
            </div>
        </section>

        <section id="adm-add" class="content-section">
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ØªØ¬Ø±</h2>
            <input type="text" id="p-title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <textarea id="p-desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
            <select id="p-style">
                <option value="normal">ØªØµÙ…ÙŠÙ… Ø¹Ø§Ø¯ÙŠ</option>
                <option value="promo">Ø¹Ø±Ø¶ Ø®Ø§Øµ (Ø¥Ø·Ø§Ø± Ø£Ø­Ù…Ø±)</option>
            </select>
            <button onclick="publishProduct()" class="btn-pay">ØªØ£ÙƒÙŠØ¯ ÙˆÙ†Ø´Ø±</button>
        </section>

        <section id="adm-users" class="content-section">
            <h2>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
            <input type="text" id="search-user-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." oninput="loadUsersForAdmin()">
            <div id="all-users-list"></div>
        </section>

        <footer>
            <div style="margin-bottom:30px;">
                <a href="https://wa.me/201014804695" class="wa-link"><i class="fab fa-whatsapp"></i> Ø¯Ø¹Ù… ÙÙ†ÙŠ 1</a>
                <a href="https://wa.me/201014806596" class="wa-link"><i class="fab fa-whatsapp"></i> Ø¯Ø¹Ù… ÙÙ†ÙŠ 2</a>
                <a href="https://wa.me/201008063749" class="wa-link" style="background:#444;"><i class="fas fa-user-shield"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
            </div>
            <p style="color:#ffd700; font-weight: bold; font-size: 16px;">Ù„Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´: 01008063749</p>
            <p style="margin-top: 25px; opacity: 0.5; font-size: 14px;">Â© 2026 Trendy Production. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGfQ35NTyNysJqeHcMGlaWQYqQ80_ecVE",
            authDomain: "trendy-production-c6d33.firebaseapp.com",
            projectId: "trendy-production-c6d33",
            databaseURL: "https://trendy-production-c6d33-default-rtdb.firebaseio.com",
            storageBucket: "trendy-production-c6d33.appspot.com",
            appId: "1:991761563640:web:2867e0a2cd16df78d3a00d"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.database();
        const admins = ["ayhia4254@gmail.com", "rfthsynrmdan@gmail.com", "husseinramadanarafa22@gmail.com", "trendyproduction166@gmail.com","adhemyahia2@gmail.com"];
        const IMGBB_API_KEY = "553dfd44418af770ea7ab27ad9f68fa5";

        // Auth Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';

                db.ref('all_users/' + user.uid).on('value', snap => {
                    const userData = snap.val();
                    if(userData) {
                        const uPic = userData.photo || user.photoURL || 'https://via.placeholder.com/120';
                        const uName = userData.name || user.displayName;

                        document.getElementById('my-pic').src = uPic;
                        document.getElementById('head-user-pic').src = uPic;
                        document.getElementById('head-user-name').innerText = uName;
                        document.getElementById('my-name-input').value = uName;
                    }
                });

                db.ref('all_users/' + user.uid).update({
                    name: user.displayName,
                    email: user.email,
                    uid: user.uid,
                    lastSeen: new Date().toLocaleString('ar-EG')
                });

                if(admins.includes(user.email)) {
                    document.getElementById('admin-zone').style.display = 'block';
                    loadUsersForAdmin();
                }

                initRealtimeListeners(user.uid);
            }
        });

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { auth.signOut().then(() => location.reload()); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        function openPage(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ImgBB ---
        async function uploadProfilePic() {
            const file = document.getElementById('pic-input').files[0];
            if(!file) return;
            alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±ØªÙƒ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
            const formData = new FormData();
            formData.append("image", file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await response.json();
                if(data.success) {
                    const url = data.data.url;
                    await auth.currentUser.updateProfile({ photoURL: url });
                    await db.ref('all_users/' + auth.currentUser.uid).update({ photo: url });
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!");
                }
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„ØµÙˆØ±"); }
        }

        async function postToForum() {
            const text = document.getElementById('forum-msg').value;
            const file = document.getElementById('forum-img').files[0];
            if(!text && !file) return;
            let url = "";
            if(file) {
                alert("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±...");
                const formData = new FormData();
                formData.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                const data = await res.json();
                if(data.success) url = data.data.url;
            }
            db.ref('forum').push({
                userName: auth.currentUser.displayName,
                userPic: auth.currentUser.photoURL || 'https://via.placeholder.com/45',
                uid: auth.currentUser.uid,
                text: text,
                img: url,
                likesCount: 0,
                isAdmin: admins.includes(auth.currentUser.email),
                date: Date.now(),
                isPinned: false
            });
            document.getElementById('forum-msg').value = '';
            document.getElementById('forum-img').value = '';
        }

        function togglePin(postId, currentState) {
            db.ref('forum/' + postId).update({ isPinned: !currentState });
        }

        function initRealtimeListeners(uid) {
            db.ref('products').on('value', snap => {
                const grid = document.getElementById('products-grid');
                grid.innerHTML = '';
                snap.forEach(child => {
                    const p = child.val();
                    grid.innerHTML += `
                        <div class="card ${p.style === 'promo' ? 'promo' : ''}">
                            <h3>${p.title}</h3>
                            <p style="font-size: 13px; color: #ccc;">${p.desc}</p>
                            <div style="font-size:24px; color:var(--blue); font-weight:bold; margin: 15px 0;">${p.price} EGP</div>
                            <button class="btn-pay" onclick="addToCart('${p.title}', ${p.price})">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
                            ${admins.includes(auth.currentUser.email) ? `<button class="btn-delete-admin" onclick="db.ref('products/${child.key}').remove()">Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</button>` : ''}
                        </div>`;
                });
            });

            db.ref('forum').on('value', snap => {
                const list = document.getElementById('forum-list');
                const posts = [];
                snap.forEach(c => { posts.push({id: c.key, ...c.val()}); });
                posts.sort((a,b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.date - a.date);
                list.innerHTML = '';
                posts.forEach(f => {
                    const myLike = f.likesData && f.likesData[auth.currentUser.uid];
                    const isAdmin = admins.includes(auth.currentUser.email);
                    let repliesHTML = '';
                    if(f.replies) { Object.values(f.replies).forEach(r => { repliesHTML += `<div class="reply-box"><b>${r.name}:</b> ${r.msg}</div>`; }); }
                    list.innerHTML += `
                        <div class="status-card ${f.isAdmin ? 'admin-post' : ''} ${f.isPinned ? 'pinned-post' : ''}">
                            ${f.isPinned ? '<div class="pin-badge"><i class="fas fa-thumbtack"></i></div>' : ''}
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                                <img src="${f.userPic}" style="width:38px; height:38px; border-radius:50%; object-fit:cover; border:1px solid var(--blue);">
                                <div><div style="font-weight:bold;">${f.userName}</div><small style="opacity:0.5; font-size:10px;">${new Date(f.date).toLocaleString('ar-EG')}</small></div>
                                <div style="margin-right:auto; display: flex; gap: 10px;">
                                    ${isAdmin ? `<i class="fas fa-thumbtack" style="color:${f.isPinned ? 'var(--gold)' : '#555'}; cursor:pointer;" onclick="togglePin('${f.id}', ${f.isPinned})"></i>` : ''}
                                    ${isAdmin ? `<i class="fas fa-trash" style="color:#ff4757; cursor:pointer;" onclick="if(confirm('Ø­Ø°ÙØŸ')) db.ref('forum/${f.id}').remove()"></i>` : ''}
                                </div>
                            </div>
                            <p style="line-height:1.6; white-space: pre-wrap;">${f.text}</p>
                            ${f.img ? `<img src="${f.img}" style="max-width:100%; border-radius:15px; margin: 10px 0;">` : ''}
                            <div style="margin-top:15px; display:flex; gap:25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:12px;">
                                <span onclick="toggleLike('${f.id}')" style="cursor:pointer; color:${myLike ? 'var(--blue)' : 'white'};"><i class="fas fa-thumbs-up"></i> ${f.likesCount || 0}</span>
                                <span onclick="replyPost('${f.id}')" style="cursor:pointer;"><i class="fas fa-reply"></i> Ø±Ø¯</span>
                            </div>
                            <div id="replies-${f.id}">${repliesHTML}</div>
                        </div>`;
                });
            });

            db.ref('all_users/' + uid + '/waiting').on('value', snap => renderStatusList(snap, 'wait-list', 'orange'));
            db.ref('all_users/' + uid + '/history').on('value', snap => renderStatusList(snap, 'history-list', 'green'));
            renderCart();
        }

        function toggleLike(postId) {
            const uid = auth.currentUser.uid;
            db.ref('forum/' + postId).once('value', snap => {
                let f = snap.val(); let likes = f.likesData || {}; let count = f.likesCount || 0;
                if(likes[uid]) { delete likes[uid]; count--; } else { likes[uid] = true; count++; }
                db.ref('forum/' + postId).update({ likesData: likes, likesCount: Math.max(0, count) });
            });
        }

        function replyPost(postId) {
            const msg = prompt("Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ:");
            if(msg) db.ref('forum/' + postId + '/replies').push({ name: auth.currentUser.displayName, msg: msg, date: Date.now() });
        }

        function addToCart(title, price) {
            db.ref('all_users/' + auth.currentUser.uid + '/cart_live').push({title, price});
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©!");
        }

        function renderCart() {
            db.ref('all_users/' + auth.currentUser.uid + '/cart_live').on('value', snap => {
                const div = document.getElementById('cart-content');
                let html = ''; let total = 0;
                snap.forEach(c => { const item = c.val(); html += `<div class="status-card" style="display:flex; justify-content:space-between;"><span>${item.title}</span><span>${item.price} EGP</span></div>`; total += parseInt(item.price); });
                div.innerHTML = html + (html ? `<h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} EGP</h3><button class="btn-pay" onclick="checkout()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>` : '<p>Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©</p>');
            });
        }

        function checkout() {
            db.ref('all_users/' + auth.currentUser.uid + '/cart_live').once('value', snap => {
                let items = []; snap.forEach(c => items.push(c.val().title));
                const orderText = items.join(' + ');
                db.ref('all_users/' + auth.currentUser.uid + '/waiting').push({ items: orderText, date: new Date().toLocaleString('ar-EG') });
                db.ref('all_users/' + auth.currentUser.uid + '/cart_live').remove();
                window.open(`https://wa.me/201008063749?text=Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ${orderText}`);
            });
        }

        function saveProfileName() {
            const newName = document.getElementById('my-name-input').value;
            if(newName) { auth.currentUser.updateProfile({ displayName: newName }).then(() => { db.ref('all_users/' + auth.currentUser.uid).update({ name: newName }); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!"); }); }
        }

        function renderStatusList(snap, elementId, borderColor) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            snap.forEach(child => { const data = child.val(); container.innerHTML += `<div class="status-card" style="border-right-color:${borderColor};"><b>${data.items}</b><br><small>${data.date}</small></div>`; });
        }

        function publishProduct() {
            const t = document.getElementById('p-title').value, p = document.getElementById('p-price').value, d = document.getElementById('p-desc').value, s = document.getElementById('p-style').value;
            if(t && p) db.ref('products').push({ title: t, price: p, desc: d, style: s }).then(() => { alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±!"); openPage('home'); });
        }

        // --- ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Ø§Ù„Ø³Ù„Ø© - Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - Ø§Ù„ÙÙˆØ§ØªÙŠØ±) ---
        function loadUsersForAdmin() {
            const searchTerm = document.getElementById('search-user-input').value.toLowerCase();
            db.ref('all_users').once('value', snap => {
                const container = document.getElementById('all-users-list');
                container.innerHTML = '';
                snap.forEach(child => {
                    const u = child.val();
                    const name = u.name ? u.name.toLowerCase() : "";
                    const email = u.email ? u.email.toLowerCase() : "";

                    if(name.includes(searchTerm) || email.includes(searchTerm)) {
                        const userPic = u.photo || 'https://via.placeholder.com/50';
                        container.innerHTML += `
                            <div class="status-card">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                    <img src="${userPic}" class="admin-user-img">
                                    <div>
                                        <b style="font-size: 16px;">${u.name}</b><br>
                                        <small style="color: var(--blue);">${u.email}</small>
                                    </div>
                                </div>
                                <div style="margin-top:10px;">
                                    <button class="admin-action-btn" style="background:#00d2ff;" onclick="adminViewDetails('${u.uid}', 'cart_live', 'Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©')">Ø§Ù„Ø³Ù„Ø©</button>
                                    <button class="admin-action-btn" style="background:orange;" onclick="adminViewDetails('${u.uid}', 'waiting', 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø©')">Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
                                    <button class="admin-action-btn" style="background:green;" onclick="adminViewDetails('${u.uid}', 'history', 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©')">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
                                </div>
                                <div id="admin-detail-${u.uid}" style="display:none; margin-top:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:10px;"></div>
                            </div>`;
                    }
                });
            });
        }

        function adminViewDetails(uid, path, title) {
            const box = document.getElementById('admin-detail-' + uid);
            box.style.display = 'block';
            db.ref('all_users/' + uid + '/' + path).once('value', snap => {
                let html = `<b>${title}:</b><br>`;
                if(!snap.exists()) { html += 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.'; }
                snap.forEach(item => {
                    const data = item.val();
                    const content = data.items || data.title || "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
                    html += `â€¢ ${content} ${path === 'waiting' ? `<button onclick="activateOrder('${uid}', '${item.key}', '${content}')">ØªÙØ¹ÙŠÙ„ âœ…</button>` : ''}<br>`;
                });
                box.innerHTML = html;
            });
        }

        function activateOrder(uid, key, items) {
            db.ref('all_users/' + uid + '/history').push({ items, date: new Date().toLocaleString('ar-EG') });
            db.ref('all_users/' + uid + '/waiting/' + key).remove();
            alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙˆÙ†Ù‚Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©!");
            adminViewDetails(uid, 'waiting', 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø©');
        }
    </script>
</body>
</html>
